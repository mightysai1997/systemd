---
# vi: ts=2 sw=2 et:
# SPDX-License-Identifier: LGPL-2.1-or-later
# Simple boot tests that build and boot the mkosi images generated by the mkosi config files in mkosi.conf.d/.
name: mkosi

on:
  push:
    branches:
      - main
      - v[0-9]+-stable
    paths:
      - '**'
      - '!README*'
      - '!LICENSE*'
      - '!LICENSES/**'
      - '!TODO'
      - '!docs/**'
      - '!man/**'
      - '!catalog/**'
      - '!shell-completion/**'
      - '!po/**'
      - '!.**'
      - '.github/**'

  pull_request:
    branches:
      - main
      - v[0-9]+-stable
    paths:
      - '**'
      - '!README*'
      - '!LICENSE*'
      - '!LICENSES/**'
      - '!TODO'
      - '!docs/**'
      - '!man/**'
      - '!catalog/**'
      - '!shell-completion/**'
      - '!po/**'
      - '!.**'
      - '.github/**'

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-22.04
    concurrency:
      group: ${{ github.workflow }}-${{ matrix.distro }}-${{ matrix.release }}-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: arch
            release: rolling
          - distro: debian
            release: testing
          - distro: ubuntu
            release: noble
          - distro: fedora
            release: "39"
          - distro: fedora
            release: rawhide
          - distro: opensuse
            release: tumbleweed
          - distro: centos
            release: "9"

    env:
      SYSTEMD_LOG_LEVEL: debug

    steps:
    - uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633
    - uses: systemd/mkosi@236784dbb597321eedab50cef06cc49f92c57293

    # Freeing up disk space with rm -rf can take multiple minutes. Since we don't need the extra free space
    # immediately, we remove the files in the background. However, we first move them to a different location
    # so that nothing tries to use anything in these directories anymore while we're busy deleting them.
    - name: Free disk space
      run: |
        sudo mv /usr/local /usr/local.trash
        sudo mv /opt/hostedtoolcache /opt/hostedtoolcache.trash
        sudo systemd-run rm -rf /usr/local.trash /opt/hostedtoolcache.trash

    - name: Btrfs
      run: |
        truncate --size=20G btrfs.raw
        mkfs.btrfs btrfs.raw
        sudo mkdir -p /mnt/mkosi
        LOOP="$(sudo losetup --find --show --direct-io=on btrfs.raw)"
        sudo mount "$LOOP" /mnt/mkosi --options compress=zstd:1,user_subvol_rm_allowed,noatime,discard=async,space_cache=v2
        sudo chown "$(id -u):$(id -g)" /mnt/mkosi

    - name: Configure
      run: |
        tee mkosi.local.conf <<EOF
        [Distribution]
        Distribution=${{ matrix.distro }}
        Release=${{ matrix.release }}

        [Output]
        # Build a disk image in CI as this logic is much more prone to breakage.
        Format=disk
        UseSubvolumes=yes

        CacheDirectory=/mnt/mkosi/mkosi.cache
        PackageCacheDirectory=/mnt/mkosi/mkosi.cache
        WorkspaceDirectory=/mnt/mkosi

        [Host]
        ToolsTree=default
        ToolsTreeDistribution=fedora
        QemuVsock=yes
        QemuKvm=yes
        # TODO: Drop once https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2038777 is fixed in Github Actions
        QemuFirmware=uefi
        EOF

        # These should override the options from mkosi.conf so we put them in a dropin that's ordered later
        # instead.
        tee mkosi.conf.d/99-ci.conf <<EOF
        [Host]
        # udev's debug log output is very verbose, so up it to info in CI.
        # Root device can take a long time to appear, so let's bump the timeout.
        KernelCommandLineExtra=udev.log_level=info
                               systemd.default_device_timeout_sec=180
        EOF

    - name: Generate secure boot key
      run: mkosi --debug genkey

    - name: Show image summary
      run: mkosi summary

    - name: Install build dependencies
      run: sudo apt-get install meson gperf libfdisk-dev libtss2-dev libblkid-dev libmicrohttpd-dev libcap-dev libcurl4-openssl-dev

    - name: Configure meson
      run: meson setup /mnt/mkosi/build -Dintegration-tests=true -Dremote=enabled -Dopenssl=enabled -Dblkid=enabled -Dtpm2=enabled

    - name: Run integration tests
      run: meson test -C /mnt/mkosi/build --suite integration-tests --num-processes "$((nproc / 2))" --print-errorlogs --no-stdsplit
      env:
        TMPDIR: /mnt/mkosi

    - name: Archive production artifacts
      uses: actions/upload-artifact@v4
      with:
        name: failed-test-journals
        path: |
          build/test/*.journal
